server {
    listen 8000; # Nginx escucha en el puerto 8000 dentro del contenedor
    index index.php index.html; # Archivos por defecto a buscar
    root /var/www/html; # La raíz de tu aplicación PHP dentro del contenedor

    # Configuración de CORS
    # Esto es lo MÁS IMPORTANTE para tu problema de CORS.
    # El '*' en Access-Control-Allow-Origin permite cualquier origen.
    # EN PRODUCCIÓN, CAMBIA '*' A TU DOMINIO ESPECÍFICO DEL FRONTEND:
    # Por ejemplo: 'https://frontend-fotos-kowa77-12fcae88.koyeb.app'

    location / {
        # Configuración para manejar las solicitudes de preflight OPTIONS
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*'; # ¡CAMBIAR PARA PRODUCCIÓN!
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With';
            add_header 'Access-Control-Max-Age' 86400; # Cachea la respuesta OPTIONS por 24 horas
            add_header 'Content-Type' 'text/plain; charset=utf-8'; # Tipo de contenido para preflight
            add_header 'Content-Length' 0; # La respuesta OPTIONS a menudo no tiene cuerpo
            return 204; # Código de estado 204 No Content para preflight exitosa
        }

        # Configuración para añadir cabeceras CORS a las solicitudes reales (GET, POST, etc.)
        add_header 'Access-Control-Allow-Origin' '*'; # ¡CAMBIAR PARA PRODUCCIÓN!
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS'; # Puede ser más específico aquí, pero no hace daño.
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With'; # Opcional aquí si ya se manejó en preflight, pero seguridad.

        # Intenta servir el archivo directamente, si no, trata como directorio, si no, pasa a index.php
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Configuración para procesar archivos PHP con PHP-FPM
    location ~ \.php$ {
        try_files $uri =404; # Retorna 404 si el archivo PHP no existe
        fastcgi_split_path_info ^(.+\.php)(/.+)$; # Separa el path del archivo PHP del resto del URL
        fastcgi_pass 127.0.0.1:9000; # Envía la solicitud a PHP-FPM, que escucha en el puerto 9000
        fastcgi_index index.php; # Archivo de índice por defecto para PHP
        include fastcgi_params; # Incluye parámetros FastCGI estándar
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; # Ruta completa del script PHP
        fastcgi_param PATH_INFO $fastcgi_path_info; # Información de path extra
    }
}
